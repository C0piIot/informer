version: '3.7'

x-informer-django: &informer-django
  environment:
    - "DEBUG=True"
    - "EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend"
    - "ROLLBAR_TOKEN=9d10822598ac487ba4a6f672d39941d5"
    - "ROLLBAR_CLIENT_TOKEN=882f4c50682347a8bf598e628144dcbf"
    - "CACHE_URL=locmemcache://"
    - "DRAMATIQ_REDIS_URL=redis://informer_redis"
    - "STATS_REDIS_URL=redis://informer_redis"
  build: 
    context: .
    target: "dev"
  volumes:
    - .:/app
  depends_on:
    - informer_redis

services:
  informer_app:
    <<: *informer-django
    container_name: informer_app
    command: >
      sh -c "python manage.py migrate &&
             python manage.py runserver 0.0.0.0:8080"
    ports:
      - "8080:8080"

  informer_worker:
    <<: *informer-django
    container_name: informer_worker
    command: "python manage.py rundramatiq --reload"   
  
  informer_redis:
    #image: redis:alpine
    image: redisfab/redistimeseries:1.8.5-arm64v8-jammy
    container_name: informer_redis
    command: "redis-server --loadmodule /usr/lib/redis/modules/redistimeseries.so DUPLICATE_POLICY sum COMPACTION_POLICY sum:1M:1h:1M;sum:30M:24h:30M;sum:1d:30d:1d ENCODING compressed"
